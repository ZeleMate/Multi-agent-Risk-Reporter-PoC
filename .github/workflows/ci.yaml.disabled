name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  # Provide a dummy key so imports/initialization that read the var won't fail.
  OPENAI_API_KEY: "sk-ci-placeholder"

jobs:
  lint:
    name: Lint & Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml

      - name: Install lint tools
        run: |
          python -m pip install --upgrade pip
          pip install black ruff mypy bandit nbqa markdownlint-cli

      - name: Black (repo)
        run: black --check . --line-length=100

      - name: Ruff (repo)
        run: ruff check .

      - name: Mypy (optional on src/)
        run: |
          if [ -d src ]; then mypy src/ || true; else echo "no src/ dir, skipping mypy"; fi

      - name: Bandit (optional on src/)
        run: |
          if [ -d src ]; then bandit -r src/ || true; else echo "no src/ dir, skipping bandit"; fi

      - name: Markdownlint (docs & README)
        run: |
          if [ -d docs ]; then markdownlint "**/*.md" || true; else echo "no docs/ dir"; fi
          if [ -f README.md ]; then markdownlint "README.md" || true; fi

      - name: NBQA (only if notebooks/ exists)
        run: |
          if [ -d notebooks ]; then
            nbqa black --check notebooks --line-length=100 || true
            nbqa ruff notebooks || true
          else
            echo "no notebooks/ dir"
          fi

  install-and-smoke:
    name: Install deps & smoke tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml

      - name: Install project (editable)
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest

      - name: Import smoke (no heavy deps)
        run: |
          python - <<'PY'
          import importlib
          for m in ["langgraph", "langchain", "chromadb", "openai"]:
              importlib.import_module(m)
          print("Core imports OK")
          PY

      - name: CI smoke script (no network)
        run: |
          python scripts/ci_smoke.py

      - name: Run unit tests (if present)
        run: |
          if [ -d tests ]; then pytest -q; else echo "No tests/ directory"; fi